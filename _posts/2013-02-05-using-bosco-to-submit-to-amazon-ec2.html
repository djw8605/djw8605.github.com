---
title: Using Bosco to submit to Amazon EC2
date: '2013-02-05T22:27:00.002-06:00'
author: Derek Weitzel
tags:
- bosco
- osg
- campus
- condor
modified_time: '2013-02-09T13:51:53.758-06:00'
thumbnail: http://1.bp.blogspot.com/-0l_ddtj9fXc/URHJOTsFD8I/AAAAAAAAB2o/lAp3Yn_RVS8/s72-c/amazoncred.png
blogger_id: tag:blogger.com,1999:blog-3007054864987759910.post-4538100752405939638
blogger_orig_url: http://derekweitzel.blogspot.com/2013/02/using-bosco-to-submit-to-amazon-ec2.html
---

A homework assignment for my storage class required running ~30 hours of benchmarks of the btrfs and ext4 filesystems. &nbsp;I thought this would be an excellent time to test Bosco's ability to submit to Amazon EC2 to parallelize the benchmarks.<br /><br /><h3>Preparing Submission</h3><div>In order to start instances on Amazon EC2, you first need to sign up. &nbsp;Go to&nbsp;<a href="https://aws.amazon.com/">https://aws.amazon.com/</a>&nbsp;and sign up in the top right. &nbsp;After you sign up, you will need the access and secret key. &nbsp;These can be found in the 'Security Credentials' from the account drop down box. &nbsp;They are in the 'Access Keys' tab under the&nbsp;'Access Key ID' and&nbsp;'Secret Access Key'. &nbsp;Write those values in 2 files, you will need them when you submit EC2 instances.</div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-0l_ddtj9fXc/URHJOTsFD8I/AAAAAAAAB2o/lAp3Yn_RVS8/s1600/amazoncred.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="441" src="http://1.bp.blogspot.com/-0l_ddtj9fXc/URHJOTsFD8I/AAAAAAAAB2o/lAp3Yn_RVS8/s640/amazoncred.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Screenshot of Amazon Security credentials site</td></tr></tbody></table><div><br /></div><div><br /></div><div>Next, you will need a script to run at startup of the Amazon instance. &nbsp;When the instance starts up, a service named <a href="https://help.ubuntu.com/community/CloudInit">CloudInit</a>&nbsp;also start on the instance. &nbsp;It will&nbsp;interpret&nbsp;the user data file as a shell script which can setup and start any other services you would like. &nbsp;My shell script is provided below.</div><div><div class="gistLoad" data-id="4719948" id="gist-4719948">Loading ....</div></div><div><br /></div><div>This shell script will install python-boto (python bindings for S3 storage and ec2) and git onto the instance. &nbsp;Next, it will download the filebenchrunner (Benchmark runner for the homework), and start it. &nbsp;Most people will probably want to shut down the instance after you are done with processing, in that case you can just add to the bottom a 'poweroff'. <br /><br /><h3>Running the Instance</h3></div><div>Running an Amazon instance is as easy as running a Bosco job. &nbsp;First, you must create a Bosco submit file. &nbsp;Below is the one I used:</div><div><div class="gistLoad" data-id="4720141" id="gist-4720141"><br /></div><div><br />Some important things to note. &nbsp;I specified ec2_spot_price, which is the amount I am willing to pay for my m1.medium instance to run per hour. &nbsp;I said $0.04 an hour, which is pretty low, but reasonable for a medium instance. &nbsp;You can find all of the current spot prices either in the AWS console, or on the EC2 <a href="https://aws.amazon.com/ec2/spot-instances/#7">website</a>. &nbsp;As you can see, the spot prices are much, much smaller than the on-demand price of an instance. &nbsp;For example, for the m1.medium instance, which has 1.7 GB of ram and 1 core, the spot price currently is $0.013 per hour. &nbsp;The on-demand price is $0.120 per hour. &nbsp;That's a 90% discount on a m1.medium. &nbsp;Of course, you should always read the <a href="https://aws.amazon.com/ec2/spot-instances/#4">downsides</a> of using a spot instance, such as it can be terminated at any time, without warning, by Amazon. &nbsp;For my benchmarks, I can always re-run benchmarks if my instance is terminated. &nbsp;I needed to run 10 - 10 minute benchmarks, therefore after every benchmark, I uploaded the resulting data to S3&nbsp;immediately so I wouldn't lose any work if the instance was terminated.<br /><br />Also, I used the regular Amazon Linux AMI. &nbsp;They are listed on the Amazon <a href="https://aws.amazon.com/amazon-linux-ami/">website</a>. &nbsp;I could have very well used a CentOS, Ubuntu, or any other linux image for my instance. &nbsp;But, I prefer the official Linux AMI since it provides a very up to date OS which is very similar to the feel of a CentOS 6 instance. &nbsp;For example, it uses yum for repository management, and RPM's to install. &nbsp;And has versions (except for the kernel) similar to CentOS 6.<br /><br />I also added a special command, periodic_remove, in order to terminate the instance if something went wrong inside the instance. &nbsp;Sometimes yum can hang, or the instance may not start up properly. &nbsp;In those cases, amazon will not notify you of the problem, and Bosco will not be able to determine there is an issue. &nbsp;Since my benchmarks should not last longer than 100 minutes, I automatically remove the instance after 150 minutes (a little breathing room) of running.<br /><br />You may submit the instance with the normal 'condor_submit' command. &nbsp;The job will move to the <b>R</b>unning state when the instance has begun running.<br /><br />Once the instance has started, you may ssh into the instance by using the unique ssh key that Bosco generates for you. &nbsp;It is specified in the submit file as&nbsp;ec2_keypair_file. &nbsp;You also need the DNS name for the instance, which is available in the job's classad. <br /><pre>condor_q -run</pre><br />The command will output the hostname of the EC2 host.  You may connect to the EC2 instance with the command, replacing the XXXX with the job number, and hostname with the address you get from the above command:<br /><pre>$ ssh -i keyfile.XXXXX ec2-user@<span style="color: red;">hostname</span></pre><br /><h3>Summary</h3><div>Pros of using Bosco to submit Amazon EC2 Jobs:</div><div><ul><li>Simple management of Amazon instance <b>from your workstation</b>.</li><li>Specify spot price right inside of the job description.</li><li>Ability to bootstrap the instance easily with user data scripts.</li><li>Ability to use HTCondor policies in order to manage the instances, such as periodic remove statement above.</li></ul>Cons:</div><div><ul><li>The EC2 universe is only available on Linux builds of Bosco. &nbsp;You cannot manage EC2 instances on the Mac version of Bosco.</li><li>Amazon EC2 has hundreds and hundreds of features, Bosco only allows you to use the simple submit EC2 instances and spot pricing. &nbsp;You will not be able to use the vast majority when you are using Bosco to manage your instances. &nbsp;But if all you need is to run some processing, Bosco is great!</li></ul></div><br /></div><script src="https://raw.github.com/moski/gist-Blogger/master/public/gistLoader.js" type="text/javascript"></script></div><center><a href="http://bosco.opensciencegrid.org/download/">     <img src="https://raw.github.com/osg-bosco/bosco-download-images/master/images/download-orange.png"       alt="Bosco Download"      style="border-width: 0;" /> </a><br /><a href="http://creativecommons.org/licenses/by/3.0/deed.en_US" rel="license"><img alt="Creative Commons License" src="http://i.creativecommons.org/l/by/3.0/88x31.png" style="border-width: 0;" /></a><br />This work is licensed under a <a href="http://creativecommons.org/licenses/by/3.0/deed.en_US" rel="license">Creative Commons Attribution 3.0 Unported License</a>. </center>
